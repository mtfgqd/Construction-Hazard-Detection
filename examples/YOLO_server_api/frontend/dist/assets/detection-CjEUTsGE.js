import{checkAccess as I,showAppropriateLinks as E,authHeaders as w}from"./common-Ceipz8Vt.js";import"./headerFooterLoader-CkcITKwD.js";const B="/api";let m=0,f=0;document.addEventListener("DOMContentLoaded",()=>{I([]),E();const e=document.getElementById("logout-btn"),n=document.getElementById("detection-form"),t=document.getElementById("detection-error"),o=document.getElementById("detection-result"),a=document.getElementById("file-drop-area"),c=document.getElementById("image-input"),s=document.getElementById("remove-image-btn"),i=document.querySelector(".choose-file-btn");C(e),L(s),S(i,c),k(a,c),b(c,a,s),D(n,c,t,o)});function C(e){e&&e.addEventListener("click",()=>{window.location.href="/login.html"})}function L(e){e.addEventListener("click",N)}function S(e,n){e&&e.addEventListener("click",t=>{t.preventDefault(),n.click()})}function k(e,n){e.addEventListener("dragover",O),e.addEventListener("dragleave",R),e.addEventListener("drop",t=>x(t,e,n))}function b(e,n,t){e.addEventListener("change",o=>{const a=o.target.files&&o.target.files[0];a&&g(a,n,t)})}function D(e,n,t,o){e.addEventListener("submit",async a=>{a.preventDefault(),H(t,o);const c=document.getElementById("model-select").value,s=n.files[0];if(!s){t.textContent="Please select an image.";return}await V(s,c,t,o)})}function O(e){e.preventDefault(),e.currentTarget.classList.add("dragover")}function R(e){e.currentTarget.classList.remove("dragover")}function x(e,n,t){e.preventDefault(),n.classList.remove("dragover");const o=e.dataTransfer.files&&e.dataTransfer.files[0];if(o){t.files=e.dataTransfer.files;const a=document.getElementById("remove-image-btn");g(o,n,a)}}function H(e,n){e.textContent="",n.textContent=""}function N(){const e=document.getElementById("image-canvas");e.getContext("2d").clearRect(0,0,e.width,e.height);const t=document.getElementById("image-input");t.value="";const o=document.getElementById("detection-result"),a=document.getElementById("detection-error");o.textContent="",a.textContent="";const c=document.getElementById("remove-image-btn");c.style.display="none"}function g(e,n,t){const o=new FileReader;o.onload=()=>P(o.result,n,t),o.readAsDataURL(e)}function P(e,n,t){const o=new Image;o.onload=()=>{m=o.width,f=o.height,T(o,n),t.style.display="inline-block"},o.src=e}function T(e,n){const t=document.getElementById("image-canvas"),o=t.getContext("2d"),{width:a,height:c}=F(e,n);t.width=a,t.height=c,o.clearRect(0,0,t.width,t.height),o.drawImage(e,0,0,a,c)}function F(e,n){const t=n.clientWidth-40,o=n.clientHeight-40;let{width:a,height:c}=e;return{width:a,height:c}=M(a,c,t,o),{width:a,height:c}}function M(e,n,t,o){if(e>t){const a=t/e;e=t,n*=a}if(n>o){const a=o/n;n=o,e*=a}return{width:e,height:n}}async function V(e,n,t,o){const a=new FormData;a.append("image",e),a.append("model",n);try{const c=await fetch(`${B}/detect`,{method:"POST",headers:w(),body:a});if(!c.ok){const i=await c.json();t.textContent=i.detail||"Detection failed.";return}const s=await c.json();j(s),W(s,o)}catch(c){console.error(c),t.textContent="Error performing detection."}}function j(e){const n=document.getElementById("image-canvas"),t=n.getContext("2d");e.forEach(o=>X(t,o,n))}function X(e,n,t){const o=["Hardhat","Mask","NO-Hardhat","NO-Mask","NO-Safety Vest","Person","Safety Cone","Safety Vest","machinery","vehicle"],a={Hardhat:"green","Safety Vest":"green",machinery:"yellow",vehicle:"yellow","NO-Hardhat":"red","NO-Safety Vest":"red",Person:"orange","Safety Cone":"pink"},[c,s,i,h,A,y]=n,r=o[y],d=a[r]||"blue",{scaledX1:l,scaledY1:u,scaledX2:v,scaledY2:p}=Y(c,s,i,h,t);$(e,l,u,v,p,d),U(e,r,l,u,d)}function Y(e,n,t,o,a){const c=a.width/m,s=a.height/f;return{scaledX1:e*c,scaledY1:n*s,scaledX2:t*c,scaledY2:o*s}}function $(e,n,t,o,a,c){e.strokeStyle=c,e.lineWidth=2,e.strokeRect(n,t,o-n,a-t)}function U(e,n,t,o,a){e.fillStyle=a,e.fillRect(t,o-20,e.measureText(n).width+10,20),e.fillStyle="black",e.font="14px Arial",e.fillText(n,t+5,o-5)}function W(e,n){const t=["Hardhat","Mask","NO-Hardhat","NO-Mask","NO-Safety Vest","Person","Safety Cone","Safety Vest","machinery","vehicle"],o=_(t);q(e,t,o),z(n,o)}function _(e){const n={};return e.forEach(t=>n[t]=0),n}function q(e,n,t){e.forEach(([,,,,,o])=>{const a=n[o];a&&(t[a]+=1)})}function z(e,n){e.textContent=Object.entries(n).filter(([t,o])=>o>0).map(([t,o])=>`${t}: ${o}`).join(`
`)}
